"use strict";Object.defineProperty(exports,"__esModule",{value:true});var crypto=require("crypto");var crypto__default=crypto["default"];var awsSdk=require("aws-sdk");var awsSdk__default=awsSdk["default"];var url=require("url");var url__default=url["default"];var util=require("util");var util__default=util["default"];var buffer=require("buffer");var buffer__default=buffer["default"];var stream=require("stream");var stream__default=stream["default"];var commonjsGlobal=typeof window!=="undefined"?window:typeof global!=="undefined"?global:typeof self!=="undefined"?self:{};function unwrapExports(x){return x&&x.__esModule?x["default"]:x}function createCommonjsModule(fn,module){return module={exports:{}},fn(module,module.exports),module.exports}var crypto$1=crypto&&crypto__default||crypto;var rb=crypto$1.randomBytes;function rng(){return rb(16)}var rng_1=rng;var byteToHex=[];for(var i=0;i<256;++i){byteToHex[i]=(i+256).toString(16).substr(1)}function bytesToUuid(buf,offset){var i=offset||0;var bth=byteToHex;return bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]}var bytesToUuid_1=bytesToUuid;var _seedBytes=rng_1();var _nodeId=[_seedBytes[0]|1,_seedBytes[1],_seedBytes[2],_seedBytes[3],_seedBytes[4],_seedBytes[5]];var _clockseq=(_seedBytes[6]<<8|_seedBytes[7])&16383;var _lastMSecs=0;var _lastNSecs=0;function v1(options,buf,offset){var i=buf&&offset||0;var b=buf||[];options=options||{};var clockseq=options.clockseq!==undefined?options.clockseq:_clockseq;var msecs=options.msecs!==undefined?options.msecs:(new Date).getTime();var nsecs=options.nsecs!==undefined?options.nsecs:_lastNSecs+1;var dt=msecs-_lastMSecs+(nsecs-_lastNSecs)/1e4;if(dt<0&&options.clockseq===undefined){clockseq=clockseq+1&16383}if((dt<0||msecs>_lastMSecs)&&options.nsecs===undefined){nsecs=0}if(nsecs>=1e4){throw new Error("uuid.v1(): Can't create more than 10M uuids/sec")}_lastMSecs=msecs;_lastNSecs=nsecs;_clockseq=clockseq;msecs+=122192928e5;var tl=((msecs&268435455)*1e4+nsecs)%4294967296;b[i++]=tl>>>24&255;b[i++]=tl>>>16&255;b[i++]=tl>>>8&255;b[i++]=tl&255;var tmh=msecs/4294967296*1e4&268435455;b[i++]=tmh>>>8&255;b[i++]=tmh&255;b[i++]=tmh>>>24&15|16;b[i++]=tmh>>>16&255;b[i++]=clockseq>>>8|128;b[i++]=clockseq&255;var node=options.node||_nodeId;for(var n=0;n<6;++n){b[i+n]=node[n]}return buf?buf:bytesToUuid_1(b)}var v1_1=v1;function v4(options,buf,offset){var i=buf&&offset||0;if(typeof options=="string"){buf=options=="binary"?new Array(16):null;options=null}options=options||{};var rnds=options.random||(options.rng||rng_1)();rnds[6]=rnds[6]&15|64;rnds[8]=rnds[8]&63|128;if(buf){for(var ii=0;ii<16;++ii){buf[i+ii]=rnds[ii]}}return buf||bytesToUuid_1(rnds)}var v4_1=v4;var uuid=v4_1;uuid.v1=v1_1;uuid.v4=v4_1;var index=uuid;var assertString_1=createCommonjsModule(function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=assertString;function assertString(input){if(typeof input!=="string"){throw new TypeError("This library (validator.js) validates strings only")}}module.exports=exports["default"]});var isUUID_1=createCommonjsModule(function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=isUUID;var _assertString2=_interopRequireDefault(assertString_1);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var uuid={3:/^[0-9A-F]{8}-[0-9A-F]{4}-3[0-9A-F]{3}-[0-9A-F]{4}-[0-9A-F]{12}$/i,4:/^[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,5:/^[0-9A-F]{8}-[0-9A-F]{4}-5[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,all:/^[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}$/i};function isUUID(str){var version=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"all";(0,_assertString2.default)(str);var pattern=uuid[version];return pattern&&pattern.test(str)}module.exports=exports["default"]});var key=createCommonjsModule(function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const createKey=({service:service,correlationKey:correlationKey=index.v4(),tags:tags={}})=>{return{__IS__A__KEY__:void 0,service:service,correlationKey:correlationKey,tags:tags}};exports.createUserKey=(({userId:userId,correlationKey:correlationKey})=>{if(!isUUID_1(userId)){throw new Error(`Invalid userId specified ${userId}`)}return createKey({service:"user",correlationKey:correlationKey,tags:{userId:userId}})});exports.createAuthenticationKey=(()=>{const key=createKey({service:"auth"});return Object.assign({},key,{setUserId(userId){const{correlationKey:correlationKey}=key;return exports.createUserKey({userId:userId,correlationKey:correlationKey})}})});exports.createServiceKey=(({service:service})=>{return createKey({service:service})});exports.tagKey=((key,tags)=>{return createKey(Object.assign({},key,{tags:Object.assign({},key.tags,tags)}))})});var aws_sdk_1=awsSdk&&awsSdk__default||awsSdk;var stream$1=createCommonjsModule(function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const isTopupAccount=account=>account.test!=null&&account.userId!=null;exports.subscribeTopups=function*(event){for(const record of event.Records){const image=aws_sdk_1.DynamoDB.Converter.output({M:record.dynamodb.NewImage});if(isTopupAccount(image)&&image.status!=null){yield image}}}});var s=1e3;var m=s*60;var h=m*60;var d=h*24;var y=d*365.25;var index$4=function(val,options){options=options||{};var type=typeof val;if(type==="string"&&val.length>0){return parse(val)}else if(type==="number"&&isNaN(val)===false){return options.long?fmtLong(val):fmtShort(val)}throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(val))};function parse(str){str=String(str);if(str.length>1e4){return}var match=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(str);if(!match){return}var n=parseFloat(match[1]);var type=(match[2]||"ms").toLowerCase();switch(type){case"years":case"year":case"yrs":case"yr":case"y":return n*y;case"days":case"day":case"d":return n*d;case"hours":case"hour":case"hrs":case"hr":case"h":return n*h;case"minutes":case"minute":case"mins":case"min":case"m":return n*m;case"seconds":case"second":case"secs":case"sec":case"s":return n*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return undefined}}function fmtShort(ms){if(ms>=d){return Math.round(ms/d)+"d"}if(ms>=h){return Math.round(ms/h)+"h"}if(ms>=m){return Math.round(ms/m)+"m"}if(ms>=s){return Math.round(ms/s)+"s"}return ms+"ms"}function fmtLong(ms){return plural(ms,d,"day")||plural(ms,h,"hour")||plural(ms,m,"minute")||plural(ms,s,"second")||ms+" ms"}function plural(ms,n,name){if(ms<n){return}if(ms<n*1.5){return Math.floor(ms/n)+" "+name}return Math.ceil(ms/n)+" "+name+"s"}var assertString_1$1=createCommonjsModule(function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=assertString;function assertString(input){if(typeof input!=="string"){throw new TypeError("This library (validator.js) validates strings only")}}module.exports=exports["default"]});var isUUID_1$1=createCommonjsModule(function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=isUUID;var _assertString2=_interopRequireDefault(assertString_1$1);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var uuid={3:/^[0-9A-F]{8}-[0-9A-F]{4}-3[0-9A-F]{3}-[0-9A-F]{4}-[0-9A-F]{12}$/i,4:/^[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,5:/^[0-9A-F]{8}-[0-9A-F]{4}-5[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,all:/^[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}$/i};function isUUID(str){var version=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"all";(0,_assertString2.default)(str);var pattern=uuid[version];return pattern&&pattern.test(str)}module.exports=exports["default"]});var merge_1=createCommonjsModule(function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=merge;function merge(){var obj=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var defaults=arguments[1];for(var key in defaults){if(typeof obj[key]==="undefined"){obj[key]=defaults[key]}}return obj}module.exports=exports["default"]});var isByteLength_1=createCommonjsModule(function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.default=isByteLength;var _assertString2=_interopRequireDefault(assertString_1);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function isByteLength(str,options){(0,_assertString2.default)(str);var min=void 0;var max=void 0;if((typeof options==="undefined"?"undefined":_typeof(options))==="object"){min=options.min||0;max=options.max}else{min=arguments[1];max=arguments[2]}var len=encodeURI(str).split(/%..|./).length-1;return len>=min&&(typeof max==="undefined"||len<=max)}module.exports=exports["default"]});var isFQDN=createCommonjsModule(function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=isFDQN;var _assertString2=_interopRequireDefault(assertString_1);var _merge2=_interopRequireDefault(merge_1);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var default_fqdn_options={require_tld:true,allow_underscores:false,allow_trailing_dot:false};function isFDQN(str,options){(0,_assertString2.default)(str);options=(0,_merge2.default)(options,default_fqdn_options);if(options.allow_trailing_dot&&str[str.length-1]==="."){str=str.substring(0,str.length-1)}var parts=str.split(".");if(options.require_tld){var tld=parts.pop();if(!parts.length||!/^([a-z\u00a1-\uffff]{2,}|xn[a-z0-9-]{2,})$/i.test(tld)){return false}}for(var part,i=0;i<parts.length;i++){part=parts[i];if(options.allow_underscores){part=part.replace(/_/g,"")}if(!/^[a-z\u00a1-\uffff0-9-]+$/i.test(part)){return false}if(/[\uff01-\uff5e]/.test(part)){return false}if(part[0]==="-"||part[part.length-1]==="-"){return false}}return true}module.exports=exports["default"]});var isEmail_1=createCommonjsModule(function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=isEmail;var _assertString2=_interopRequireDefault(assertString_1);var _merge2=_interopRequireDefault(merge_1);var _isByteLength2=_interopRequireDefault(isByteLength_1);var _isFQDN2=_interopRequireDefault(isFQDN);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var default_email_options={allow_display_name:false,require_display_name:false,allow_utf8_local_part:true,require_tld:true};var displayName=/^[a-z\d!#\$%&'\*\+\-\/=\?\^_`{\|}~\.\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+[a-z\d!#\$%&'\*\+\-\/=\?\^_`{\|}~\.\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF\s]*<(.+)>$/i;var emailUserPart=/^[a-z\d!#\$%&'\*\+\-\/=\?\^_`{\|}~]+$/i;var quotedEmailUser=/^([\s\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e]|(\\[\x01-\x09\x0b\x0c\x0d-\x7f]))*$/i;var emailUserUtf8Part=/^[a-z\d!#\$%&'\*\+\-\/=\?\^_`{\|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+$/i;var quotedEmailUserUtf8=/^([\s\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|(\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*$/i;function isEmail(str,options){(0,_assertString2.default)(str);options=(0,_merge2.default)(options,default_email_options);if(options.require_display_name||options.allow_display_name){var display_email=str.match(displayName);if(display_email){str=display_email[1]}else if(options.require_display_name){return false}}var parts=str.split("@");var domain=parts.pop();var user=parts.join("@");var lower_domain=domain.toLowerCase();if(lower_domain==="gmail.com"||lower_domain==="googlemail.com"){user=user.replace(/\./g,"").toLowerCase()}if(!(0,_isByteLength2.default)(user,{max:64})||!(0,_isByteLength2.default)(domain,{max:256})){return false}if(!(0,_isFQDN2.default)(domain,{require_tld:options.require_tld})){return false}if(user[0]==='"'){user=user.slice(1,user.length-1);return options.allow_utf8_local_part?quotedEmailUserUtf8.test(user):quotedEmailUser.test(user)}var pattern=options.allow_utf8_local_part?emailUserUtf8Part:emailUserPart;var user_parts=user.split(".");for(var i=0;i<user_parts.length;i++){if(!pattern.test(user_parts[i])){return false}}return true}module.exports=exports["default"]});var assert=createCommonjsModule(function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.createAssertValidUuid=(name=>uuid=>{if(uuid==null||!isUUID_1(uuid,4)){throw new Error(`Invalid ${name} ${uuid}`)}});exports.assertValidUuid=((key,value)=>{if(value==null||!isUUID_1(value,4)){throw new Error(`Invalid ${key} ${value}`)}});exports.assertValidString=((key,value)=>{if(typeof value!=="string"){throw new Error(`Invalid ${key} ${value}`)}});exports.assertPositiveInteger=((key,value)=>{if(!Number.isInteger(value)||value<0){throw new Error(`Invalid ${key} ${value}`)}});exports.assertNonZeroPositiveInteger=((key,value)=>{if(!Number.isInteger(value)||value<=0){throw new Error(`Invalid ${key} ${value}`)}});exports.assertObject=((key,value)=>{if(typeof value!=="object"){throw new Error(`Invalid ${key} ${value}`)}});exports.assertOptional=(validator=>{return(key,value)=>{if(value!=null){validator(key,value)}}});exports.assertValidEmailAddress=(emailAddress=>{if(emailAddress==null||!isEmail_1(emailAddress)){throw new Error(`Invalid emailAddress ${emailAddress}`)}});exports.createAssertValidObject=(validator=>object=>{for(const key of Object.keys(validator)){const value=object[key];validator[key](key,value)}const unexpectedKeys=Object.keys(object).filter(key=>!(key in validator));if(unexpectedKeys.length!==0){throw new Error(`Unexpected key(s) found on object: ${unexpectedKeys}`)}});exports.assertNever=(value=>{throw new Error(`Invalid value ${value}`)})});var error$1=createCommonjsModule(function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});class CodedError extends Error{constructor(code,message){super(message);this.code=code}}exports.CodedError=CodedError});var s$1=1e3;var m$1=s$1*60;var h$1=m$1*60;var d$1=h$1*24;var y$1=d$1*365.25;var index$6=function(val,options){options=options||{};var type=typeof val;if(type==="string"&&val.length>0){return parse$1(val)}else if(type==="number"&&isNaN(val)===false){return options.long?fmtLong$1(val):fmtShort$1(val)}throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(val))};function parse$1(str){str=String(str);if(str.length>1e4){return}var match=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(str);if(!match){return}var n=parseFloat(match[1]);var type=(match[2]||"ms").toLowerCase();switch(type){case"years":case"year":case"yrs":case"yr":case"y":return n*y$1;case"days":case"day":case"d":return n*d$1;case"hours":case"hour":case"hrs":case"hr":case"h":return n*h$1;case"minutes":case"minute":case"mins":case"min":case"m":return n*m$1;case"seconds":case"second":case"secs":case"sec":case"s":return n*s$1;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return undefined}}function fmtShort$1(ms){if(ms>=d$1){return Math.round(ms/d$1)+"d"}if(ms>=h$1){return Math.round(ms/h$1)+"h"}if(ms>=m$1){return Math.round(ms/m$1)+"m"}if(ms>=s$1){return Math.round(ms/s$1)+"s"}return ms+"ms"}function fmtLong$1(ms){return plural$1(ms,d$1,"day")||plural$1(ms,h$1,"hour")||plural$1(ms,m$1,"minute")||plural$1(ms,s$1,"second")||ms+" ms"}function plural$1(ms,n,name){if(ms<n){return}if(ms<n*1.5){return Math.floor(ms/n)+" "+name}return Math.ceil(ms/n)+" "+name+"s"}var hasOwnProperty=Object.prototype.hasOwnProperty;var pseudomap=PseudoMap;function PseudoMap(set){if(!(this instanceof PseudoMap))throw new TypeError("Constructor PseudoMap requires 'new'");this.clear();if(set){if(set instanceof PseudoMap||typeof Map==="function"&&set instanceof Map)set.forEach(function(value,key){this.set(key,value)},this);else if(Array.isArray(set))set.forEach(function(kv){this.set(kv[0],kv[1])},this);else throw new TypeError("invalid argument")}}PseudoMap.prototype.forEach=function(fn,thisp){thisp=thisp||this;Object.keys(this._data).forEach(function(k){if(k!=="size")fn.call(thisp,this._data[k].value,this._data[k].key)},this)};PseudoMap.prototype.has=function(k){return!!find(this._data,k)};PseudoMap.prototype.get=function(k){var res=find(this._data,k);return res&&res.value};PseudoMap.prototype.set=function(k,v){set(this._data,k,v)};PseudoMap.prototype.delete=function(k){var res=find(this._data,k);if(res){delete this._data[res._index];this._data.size--}};PseudoMap.prototype.clear=function(){var data=Object.create(null);data.size=0;Object.defineProperty(this,"_data",{value:data,enumerable:false,configurable:true,writable:false})};Object.defineProperty(PseudoMap.prototype,"size",{get:function(){return this._data.size},set:function(n){},enumerable:true,configurable:true});PseudoMap.prototype.values=PseudoMap.prototype.keys=PseudoMap.prototype.entries=function(){throw new Error("iterators are not implemented in this version")};function same(a,b){return a===b||a!==a&&b!==b}function Entry$1(k,v,i){this.key=k;this.value=v;this._index=i}function find(data,k){for(var i=0,s="_"+k,key=s;hasOwnProperty.call(data,key);key=s+i++){if(same(data[key].key,k))return data[key]}}function set(data,k,v){for(var i=0,s="_"+k,key=s;hasOwnProperty.call(data,key);key=s+i++){if(same(data[key].key,k)){data[key].value=v;return}}data.size++;data[key]=new Entry$1(k,v,key)}var map=createCommonjsModule(function(module){if(process.env.npm_package_name==="pseudomap"&&process.env.npm_lifecycle_script==="test")process.env.TEST_PSEUDOMAP="true";if(typeof Map==="function"&&!process.env.TEST_PSEUDOMAP){module.exports=Map}else{module.exports=pseudomap}});var yallist=Yallist;Yallist.Node=Node;Yallist.create=Yallist;function Yallist(list){var self=this;if(!(self instanceof Yallist)){self=new Yallist}self.tail=null;self.head=null;self.length=0;if(list&&typeof list.forEach==="function"){list.forEach(function(item){self.push(item)})}else if(arguments.length>0){for(var i=0,l=arguments.length;i<l;i++){self.push(arguments[i])}}return self}Yallist.prototype.removeNode=function(node){if(node.list!==this){throw new Error("removing node which does not belong to this list")}var next=node.next;var prev=node.prev;if(next){next.prev=prev}if(prev){prev.next=next}if(node===this.head){this.head=next}if(node===this.tail){this.tail=prev}node.list.length--;node.next=null;node.prev=null;node.list=null};Yallist.prototype.unshiftNode=function(node){if(node===this.head){return}if(node.list){node.list.removeNode(node)}var head=this.head;node.list=this;node.next=head;if(head){head.prev=node}this.head=node;if(!this.tail){this.tail=node}this.length++};Yallist.prototype.pushNode=function(node){if(node===this.tail){return}if(node.list){node.list.removeNode(node)}var tail=this.tail;node.list=this;node.prev=tail;if(tail){tail.next=node}this.tail=node;if(!this.head){this.head=node}this.length++};Yallist.prototype.push=function(){for(var i=0,l=arguments.length;i<l;i++){push(this,arguments[i])}return this.length};Yallist.prototype.unshift=function(){for(var i=0,l=arguments.length;i<l;i++){unshift(this,arguments[i])}return this.length};Yallist.prototype.pop=function(){if(!this.tail){return undefined}var res=this.tail.value;this.tail=this.tail.prev;if(this.tail){this.tail.next=null}else{this.head=null}this.length--;return res};Yallist.prototype.shift=function(){if(!this.head){return undefined}var res=this.head.value;this.head=this.head.next;if(this.head){this.head.prev=null}else{this.tail=null}this.length--;return res};Yallist.prototype.forEach=function(fn,thisp){thisp=thisp||this;for(var walker=this.head,i=0;walker!==null;i++){fn.call(thisp,walker.value,i,this);walker=walker.next}};Yallist.prototype.forEachReverse=function(fn,thisp){thisp=thisp||this;for(var walker=this.tail,i=this.length-1;walker!==null;i--){fn.call(thisp,walker.value,i,this);walker=walker.prev}};Yallist.prototype.get=function(n){for(var i=0,walker=this.head;walker!==null&&i<n;i++){walker=walker.next}if(i===n&&walker!==null){return walker.value}};Yallist.prototype.getReverse=function(n){for(var i=0,walker=this.tail;walker!==null&&i<n;i++){walker=walker.prev}if(i===n&&walker!==null){return walker.value}};Yallist.prototype.map=function(fn,thisp){thisp=thisp||this;var res=new Yallist;for(var walker=this.head;walker!==null;){res.push(fn.call(thisp,walker.value,this));walker=walker.next}return res};Yallist.prototype.mapReverse=function(fn,thisp){thisp=thisp||this;var res=new Yallist;for(var walker=this.tail;walker!==null;){res.push(fn.call(thisp,walker.value,this));walker=walker.prev}return res};Yallist.prototype.reduce=function(fn,initial){var acc;var walker=this.head;if(arguments.length>1){acc=initial}else if(this.head){walker=this.head.next;acc=this.head.value}else{throw new TypeError("Reduce of empty list with no initial value")}for(var i=0;walker!==null;i++){acc=fn(acc,walker.value,i);walker=walker.next}return acc};Yallist.prototype.reduceReverse=function(fn,initial){var acc;var walker=this.tail;if(arguments.length>1){acc=initial}else if(this.tail){walker=this.tail.prev;acc=this.tail.value}else{throw new TypeError("Reduce of empty list with no initial value")}for(var i=this.length-1;walker!==null;i--){acc=fn(acc,walker.value,i);walker=walker.prev}return acc};Yallist.prototype.toArray=function(){var arr=new Array(this.length);for(var i=0,walker=this.head;walker!==null;i++){arr[i]=walker.value;walker=walker.next}return arr};Yallist.prototype.toArrayReverse=function(){var arr=new Array(this.length);for(var i=0,walker=this.tail;walker!==null;i++){arr[i]=walker.value;walker=walker.prev}return arr};Yallist.prototype.slice=function(from,to){to=to||this.length;if(to<0){to+=this.length}from=from||0;if(from<0){from+=this.length}var ret=new Yallist;if(to<from||to<0){return ret}if(from<0){from=0}if(to>this.length){to=this.length}for(var i=0,walker=this.head;walker!==null&&i<from;i++){walker=walker.next}for(;walker!==null&&i<to;i++,walker=walker.next){ret.push(walker.value)}return ret};Yallist.prototype.sliceReverse=function(from,to){to=to||this.length;if(to<0){to+=this.length}from=from||0;if(from<0){from+=this.length}var ret=new Yallist;if(to<from||to<0){return ret}if(from<0){from=0}if(to>this.length){to=this.length}for(var i=this.length,walker=this.tail;walker!==null&&i>to;i--){walker=walker.prev}for(;walker!==null&&i>from;i--,walker=walker.prev){ret.push(walker.value)}return ret};Yallist.prototype.reverse=function(){var head=this.head;var tail=this.tail;for(var walker=head;walker!==null;walker=walker.prev){var p=walker.prev;walker.prev=walker.next;walker.next=p}this.head=tail;this.tail=head;return this};function push(self,item){self.tail=new Node(item,self.tail,null,self);if(!self.head){self.head=self.tail}self.length++}function unshift(self,item){self.head=new Node(item,null,self.head,self);if(!self.tail){self.tail=self.head}self.length++}function Node(value,prev,next,list){if(!(this instanceof Node)){return new Node(value,prev,next,list)}this.list=list;this.value=value;if(prev){prev.next=this;this.prev=prev}else{this.prev=null}if(next){next.prev=this;this.next=next}else{this.next=null}}var util$1=util&&util__default||util;var lruCache=LRUCache;var symbols={};var hasSymbol=typeof Symbol==="function";var makeSymbol;if(hasSymbol){makeSymbol=function(key){return Symbol.for(key)}}else{makeSymbol=function(key){return"_"+key}}function priv(obj,key,val){var sym;if(symbols[key]){sym=symbols[key]}else{sym=makeSymbol(key);symbols[key]=sym}if(arguments.length===2){return obj[sym]}else{obj[sym]=val;return val}}function naiveLength(){return 1}function LRUCache(options){if(!(this instanceof LRUCache)){return new LRUCache(options)}if(typeof options==="number"){options={max:options}}if(!options){options={}}var max=priv(this,"max",options.max);if(!max||!(typeof max==="number")||max<=0){priv(this,"max",Infinity)}var lc=options.length||naiveLength;if(typeof lc!=="function"){lc=naiveLength}priv(this,"lengthCalculator",lc);priv(this,"allowStale",options.stale||false);priv(this,"maxAge",options.maxAge||0);priv(this,"dispose",options.dispose);this.reset()}Object.defineProperty(LRUCache.prototype,"max",{set:function(mL){if(!mL||!(typeof mL==="number")||mL<=0){mL=Infinity}priv(this,"max",mL);trim(this)},get:function(){return priv(this,"max")},enumerable:true});Object.defineProperty(LRUCache.prototype,"allowStale",{set:function(allowStale){priv(this,"allowStale",!!allowStale)},get:function(){return priv(this,"allowStale")},enumerable:true});Object.defineProperty(LRUCache.prototype,"maxAge",{set:function(mA){if(!mA||!(typeof mA==="number")||mA<0){mA=0}priv(this,"maxAge",mA);trim(this)},get:function(){return priv(this,"maxAge")},enumerable:true});Object.defineProperty(LRUCache.prototype,"lengthCalculator",{set:function(lC){if(typeof lC!=="function"){lC=naiveLength}if(lC!==priv(this,"lengthCalculator")){priv(this,"lengthCalculator",lC);priv(this,"length",0);priv(this,"lruList").forEach(function(hit){hit.length=priv(this,"lengthCalculator").call(this,hit.value,hit.key);priv(this,"length",priv(this,"length")+hit.length)},this)}trim(this)},get:function(){return priv(this,"lengthCalculator")},enumerable:true});Object.defineProperty(LRUCache.prototype,"length",{get:function(){return priv(this,"length")},enumerable:true});Object.defineProperty(LRUCache.prototype,"itemCount",{get:function(){return priv(this,"lruList").length},enumerable:true});LRUCache.prototype.rforEach=function(fn,thisp){thisp=thisp||this;for(var walker=priv(this,"lruList").tail;walker!==null;){var prev=walker.prev;forEachStep(this,fn,walker,thisp);walker=prev}};function forEachStep(self,fn,node,thisp){var hit=node.value;if(isStale(self,hit)){del(self,node);if(!priv(self,"allowStale")){hit=undefined}}if(hit){fn.call(thisp,hit.value,hit.key,self)}}LRUCache.prototype.forEach=function(fn,thisp){thisp=thisp||this;for(var walker=priv(this,"lruList").head;walker!==null;){var next=walker.next;forEachStep(this,fn,walker,thisp);walker=next}};LRUCache.prototype.keys=function(){return priv(this,"lruList").toArray().map(function(k){return k.key},this)};LRUCache.prototype.values=function(){return priv(this,"lruList").toArray().map(function(k){return k.value},this)};LRUCache.prototype.reset=function(){if(priv(this,"dispose")&&priv(this,"lruList")&&priv(this,"lruList").length){priv(this,"lruList").forEach(function(hit){priv(this,"dispose").call(this,hit.key,hit.value)},this)}priv(this,"cache",new map);priv(this,"lruList",new yallist);priv(this,"length",0)};LRUCache.prototype.dump=function(){return priv(this,"lruList").map(function(hit){if(!isStale(this,hit)){return{k:hit.key,v:hit.value,e:hit.now+(hit.maxAge||0)}}},this).toArray().filter(function(h){return h})};LRUCache.prototype.dumpLru=function(){return priv(this,"lruList")};LRUCache.prototype.inspect=function(n,opts){var str="LRUCache {";var extras=false;var as=priv(this,"allowStale");if(as){str+="\n  allowStale: true";extras=true}var max=priv(this,"max");if(max&&max!==Infinity){if(extras){str+=","}str+="\n  max: "+util$1.inspect(max,opts);extras=true}var maxAge=priv(this,"maxAge");if(maxAge){if(extras){str+=","}str+="\n  maxAge: "+util$1.inspect(maxAge,opts);extras=true}var lc=priv(this,"lengthCalculator");if(lc&&lc!==naiveLength){if(extras){str+=","}str+="\n  length: "+util$1.inspect(priv(this,"length"),opts);extras=true}var didFirst=false;priv(this,"lruList").forEach(function(item){if(didFirst){str+=",\n  "}else{if(extras){str+=",\n"}didFirst=true;str+="\n  "}var key=util$1.inspect(item.key).split("\n").join("\n  ");var val={value:item.value};if(item.maxAge!==maxAge){val.maxAge=item.maxAge}if(lc!==naiveLength){val.length=item.length}if(isStale(this,item)){val.stale=true}val=util$1.inspect(val,opts).split("\n").join("\n  ");str+=key+" => "+val});if(didFirst||extras){str+="\n"}str+="}";return str};LRUCache.prototype.set=function(key,value,maxAge){maxAge=maxAge||priv(this,"maxAge");var now=maxAge?Date.now():0;var len=priv(this,"lengthCalculator").call(this,value,key);if(priv(this,"cache").has(key)){if(len>priv(this,"max")){del(this,priv(this,"cache").get(key));return false}var node=priv(this,"cache").get(key);var item=node.value;if(priv(this,"dispose")){priv(this,"dispose").call(this,key,item.value)}item.now=now;item.maxAge=maxAge;item.value=value;priv(this,"length",priv(this,"length")+(len-item.length));item.length=len;this.get(key);trim(this);return true}var hit=new Entry(key,value,len,now,maxAge);if(hit.length>priv(this,"max")){if(priv(this,"dispose")){priv(this,"dispose").call(this,key,value)}return false}priv(this,"length",priv(this,"length")+hit.length);priv(this,"lruList").unshift(hit);priv(this,"cache").set(key,priv(this,"lruList").head);trim(this);return true};LRUCache.prototype.has=function(key){if(!priv(this,"cache").has(key))return false;var hit=priv(this,"cache").get(key).value;if(isStale(this,hit)){return false}return true};LRUCache.prototype.get=function(key){return get(this,key,true)};LRUCache.prototype.peek=function(key){return get(this,key,false)};LRUCache.prototype.pop=function(){var node=priv(this,"lruList").tail;if(!node)return null;del(this,node);return node.value};LRUCache.prototype.del=function(key){del(this,priv(this,"cache").get(key))};LRUCache.prototype.load=function(arr){this.reset();var now=Date.now();for(var l=arr.length-1;l>=0;l--){var hit=arr[l];var expiresAt=hit.e||0;if(expiresAt===0){this.set(hit.k,hit.v)}else{var maxAge=expiresAt-now;if(maxAge>0){this.set(hit.k,hit.v,maxAge)}}}};LRUCache.prototype.prune=function(){var self=this;priv(this,"cache").forEach(function(value,key){get(self,key,false)})};function get(self,key,doUse){var node=priv(self,"cache").get(key);if(node){var hit=node.value;if(isStale(self,hit)){del(self,node);if(!priv(self,"allowStale"))hit=undefined}else{if(doUse){priv(self,"lruList").unshiftNode(node)}}if(hit)hit=hit.value}return hit}function isStale(self,hit){if(!hit||!hit.maxAge&&!priv(self,"maxAge")){return false}var stale=false;var diff=Date.now()-hit.now;if(hit.maxAge){stale=diff>hit.maxAge}else{stale=priv(self,"maxAge")&&diff>priv(self,"maxAge")}return stale}function trim(self){if(priv(self,"length")>priv(self,"max")){for(var walker=priv(self,"lruList").tail;priv(self,"length")>priv(self,"max")&&walker!==null;){var prev=walker.prev;del(self,walker);walker=prev}}}function del(self,node){if(node){var hit=node.value;if(priv(self,"dispose")){priv(self,"dispose").call(this,hit.key,hit.value)}priv(self,"length",priv(self,"length")-hit.length);priv(self,"cache").delete(hit.key);priv(self,"lruList").removeNode(node)}}function Entry(key,value,length,now,maxAge){this.key=key;this.value=value;this.length=length;this.now=now;this.maxAge=maxAge||0}var ac=AsyncCache;function AsyncCache(opt){if(!opt||typeof opt!=="object"){throw new Error("options must be an object")}if(!opt.load){throw new Error("load function is required")}if(!(this instanceof AsyncCache)){return new AsyncCache(opt)}this._opt=opt;this._cache=new lruCache(opt);this._load=opt.load;this._loading={};this._stales={};this._allowStale=opt.stale}Object.defineProperty(AsyncCache.prototype,"itemCount",{get:function(){return this._cache.itemCount},enumerable:true,configurable:true});AsyncCache.prototype.get=function(key,cb){var stale=this._stales[key];if(this._allowStale&&stale!==undefined){return process.nextTick(function(){cb(null,stale)})}if(this._loading[key]){return this._loading[key].push(cb)}var has=this._cache.has(key);var cached=this._cache.get(key);if(has&&undefined!==cached){return process.nextTick(function(){cb(null,cached)})}if(undefined!==cached&&this._allowStale&&!has){this._stales[key]=cached;process.nextTick(function(){cb(null,cached)})}else{this._loading[key]=[cb]}this._load(key,function(er,res,maxAge){if(!er){this._cache.set(key,res,maxAge)}if(this._allowStale){delete this._stales[key]}var cbs=this._loading[key];if(!cbs){return}delete this._loading[key];cbs.forEach(function(cb){cb(er,res)})}.bind(this))};AsyncCache.prototype.keys=function(){return this._cache.keys()};AsyncCache.prototype.set=function(key,val,maxAge){return this._cache.set(key,val,maxAge)};AsyncCache.prototype.reset=function(){return this._cache.reset()};AsyncCache.prototype.has=function(key){return this._cache.has(key)};AsyncCache.prototype.del=function(key){return this._cache.del(key)};AsyncCache.prototype.peek=function(key){return this._cache.peek(key)};var asyncCache=createCommonjsModule(function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});Symbol.asyncIterator=Symbol.for("asyncIterator");exports.default=(options=>{const cache=ac(Object.assign({},options,{load:(key,cb)=>{options.load(key).then(result=>cb(null,result)).catch(cb)}}));const get=key=>new Promise((resolve,reject)=>cache.get(key,(error,result)=>{if(error){return reject(error)}resolve(result)}));return{get:get}})});var baseUrl=createCommonjsModule(function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.baseUrl=process.env.BASE_URL;if(exports.baseUrl==null){throw new Error("no $BASE_URL provided")}exports.lambdaBaseUrl=process.env.LAMBDA_BASE_URL;if(exports.lambdaBaseUrl==null){throw new Error("no $LAMBDA_BASE_URL provided")}});var log_1=createCommonjsModule(function(module,exports){"use strict";var __rest=commonjsGlobal&&commonjsGlobal.__rest||function(s,e){var t={};for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0)t[p]=s[p];if(s!=null&&typeof Object.getOwnPropertySymbols==="function")for(var i=0,p=Object.getOwnPropertySymbols(s);i<p.length;i++)if(e.indexOf(p[i])<0)t[p[i]]=s[p[i]];return t};Object.defineProperty(exports,"__esModule",{value:true});const replacer=(_key,value)=>{if(value instanceof Error){const{message:message,stack:stack}=value,rest=__rest(value,["message","stack"]);return Object.assign({message:message,stack:stack},rest)}return value};const log=(level,key,message,...args)=>{const output=Object.assign({},key,{time:(new Date).toISOString(),lvl:level,msg:message,args:args});const json=JSON.stringify(output,replacer);console.log(json)};exports.debug=((key,message,...args)=>{log("DEBUG",key,message,args)});exports.info=((key,message,...args)=>{log("INFO",key,message,args)});exports.warn=((key,message,...args)=>{log("WARN",key,message,args)});exports.error=((key,message,...args)=>{log("ERROR",key,message,args)})});var padString_1=createCommonjsModule(function(module,exports){"use strict";function padString(input){var segmentLength=4;var stringLength=input.length;var diff=stringLength%segmentLength;if(!diff){return input}var position=stringLength;var padLength=segmentLength-diff;var paddedStringLength=stringLength+padLength;var buffer$$1=new Buffer(paddedStringLength);buffer$$1.write(input);while(padLength--){buffer$$1.write("=",position++)}return buffer$$1.toString()}Object.defineProperty(exports,"__esModule",{value:true});exports.default=padString});var base64url_1=createCommonjsModule(function(module,exports){"use strict";function encode(input,encoding){if(encoding===void 0){encoding="utf8"}if(Buffer.isBuffer(input)){return fromBase64(input.toString("base64"))}return fromBase64(new Buffer(input,encoding).toString("base64"))}function decode(base64url,encoding){if(encoding===void 0){encoding="utf8"}return new Buffer(toBase64(base64url),"base64").toString(encoding)}function toBase64(base64url){base64url=base64url.toString();return padString_1.default(base64url).replace(/\-/g,"+").replace(/_/g,"/")}function fromBase64(base64){return base64.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function toBuffer(base64url){return new Buffer(toBase64(base64url),"base64")}var base64url=encode;base64url.encode=encode;base64url.decode=decode;base64url.toBase64=toBase64;base64url.fromBase64=fromBase64;base64url.toBuffer=toBuffer;Object.defineProperty(exports,"__esModule",{value:true});exports.default=base64url});var index$12=createCommonjsModule(function(module){module.exports=base64url_1.default;module.exports.default=module.exports});var require$$0$2=buffer&&buffer__default||buffer;var index$14=createCommonjsModule(function(module,exports){if(Buffer.from&&Buffer.alloc&&Buffer.allocUnsafe&&Buffer.allocUnsafeSlow){module.exports=require$$0$2}else{Object.keys(require$$0$2).forEach(function(prop){exports[prop]=require$$0$2[prop]});exports.Buffer=SafeBuffer}function SafeBuffer(arg,encodingOrOffset,length){return Buffer(arg,encodingOrOffset,length)}Object.keys(Buffer).forEach(function(prop){SafeBuffer[prop]=Buffer[prop]});SafeBuffer.from=function(arg,encodingOrOffset,length){if(typeof arg==="number"){throw new TypeError("Argument must not be a number")}return Buffer(arg,encodingOrOffset,length)};SafeBuffer.alloc=function(size,fill,encoding){if(typeof size!=="number"){throw new TypeError("Argument must be a number")}var buf=Buffer(size);if(fill!==undefined){if(typeof encoding==="string"){buf.fill(fill,encoding)}else{buf.fill(fill)}}else{buf.fill(0)}return buf};SafeBuffer.allocUnsafe=function(size){if(typeof size!=="number"){throw new TypeError("Argument must be a number")}return Buffer(size)};SafeBuffer.allocUnsafeSlow=function(size){if(typeof size!=="number"){throw new TypeError("Argument must be a number")}return require$$0$2.SlowBuffer(size)}});var Stream=stream&&stream__default||stream;var Buffer$1=index$14.Buffer;function DataStream(data){this.buffer=null;this.writable=true;this.readable=true;if(!data){this.buffer=Buffer$1.alloc(0);return this}if(typeof data.pipe==="function"){this.buffer=Buffer$1.alloc(0);data.pipe(this);return this}if(data.length||typeof data==="object"){this.buffer=data;this.writable=false;process.nextTick(function(){this.emit("end",data);this.readable=false;this.emit("close")}.bind(this));return this}throw new TypeError("Unexpected data type ("+typeof data+")")}util$1.inherits(DataStream,Stream);DataStream.prototype.write=function write(data){this.buffer=Buffer$1.concat([this.buffer,Buffer$1.from(data)]);this.emit("data",data)};DataStream.prototype.end=function end(data){if(data)this.write(data);this.emit("end",data);this.emit("close");this.writable=false;this.readable=false};var dataStream=DataStream;var Buffer$3=require$$0$2.Buffer;var SlowBuffer=require$$0$2.SlowBuffer;var index$18=bufferEq;function bufferEq(a,b){if(!Buffer$3.isBuffer(a)||!Buffer$3.isBuffer(b)){return false}if(a.length!==b.length){return false}var c=0;for(var i=0;i<a.length;i++){c|=a[i]^b[i]}return c===0}bufferEq.install=function(){Buffer$3.prototype.equal=SlowBuffer.prototype.equal=function equal(that){return bufferEq(this,that)}};var origBufEqual=Buffer$3.prototype.equal;var origSlowBufEqual=SlowBuffer.prototype.equal;bufferEq.restore=function(){Buffer$3.prototype.equal=origBufEqual;SlowBuffer.prototype.equal=origSlowBufEqual};function getParamSize(keySize){var result=(keySize/8|0)+(keySize%8===0?0:1);return result}var paramBytesForAlg={ES256:getParamSize(256),ES384:getParamSize(384),ES512:getParamSize(521)};function getParamBytesForAlg(alg){var paramBytes=paramBytesForAlg[alg];if(paramBytes){return paramBytes}throw new Error('Unknown algorithm "'+alg+'"')}var paramBytesForAlg_1=getParamBytesForAlg;var base64Url=index$12.fromBase64;var Buffer$4=index$14.Buffer;var MAX_OCTET=128;var CLASS_UNIVERSAL=0;var PRIMITIVE_BIT=32;var TAG_SEQ=16;var TAG_INT=2;var ENCODED_TAG_SEQ=TAG_SEQ|PRIMITIVE_BIT|CLASS_UNIVERSAL<<6;var ENCODED_TAG_INT=TAG_INT|CLASS_UNIVERSAL<<6;function signatureAsBuffer(signature){if(Buffer$4.isBuffer(signature)){return signature}else if("string"===typeof signature){return Buffer$4.from(signature,"base64")}throw new TypeError("ECDSA signature must be a Base64 string or a Buffer")}function derToJose(signature,alg){signature=signatureAsBuffer(signature);var paramBytes=paramBytesForAlg_1(alg);var maxEncodedParamLength=paramBytes+1;var inputLength=signature.length;var offset=0;if(signature[offset++]!==ENCODED_TAG_SEQ){throw new Error('Could not find expected "seq"')}var seqLength=signature[offset++];if(seqLength===(MAX_OCTET|1)){seqLength=signature[offset++]}if(inputLength-offset<seqLength){throw new Error('"seq" specified length of "'+seqLength+'", only "'+(inputLength-offset)+'" remaining')}if(signature[offset++]!==ENCODED_TAG_INT){throw new Error('Could not find expected "int" for "r"')}var rLength=signature[offset++];if(inputLength-offset-2<rLength){throw new Error('"r" specified length of "'+rLength+'", only "'+(inputLength-offset-2)+'" available')}if(maxEncodedParamLength<rLength){throw new Error('"r" specified length of "'+rLength+'", max of "'+maxEncodedParamLength+'" is acceptable')}var rOffset=offset;offset+=rLength;if(signature[offset++]!==ENCODED_TAG_INT){throw new Error('Could not find expected "int" for "s"')}var sLength=signature[offset++];if(inputLength-offset!==sLength){throw new Error('"s" specified length of "'+sLength+'", expected "'+(inputLength-offset)+'"')}if(maxEncodedParamLength<sLength){throw new Error('"s" specified length of "'+sLength+'", max of "'+maxEncodedParamLength+'" is acceptable')}var sOffset=offset;offset+=sLength;if(offset!==inputLength){throw new Error('Expected to consume entire buffer, but "'+(inputLength-offset)+'" bytes remain')}var rPadding=paramBytes-rLength,sPadding=paramBytes-sLength;var dst=Buffer$4.allocUnsafe(rPadding+rLength+sPadding+sLength);for(offset=0;offset<rPadding;++offset){dst[offset]=0}signature.copy(dst,offset,rOffset+Math.max(-rPadding,0),rOffset+rLength);offset=paramBytes;for(var o=offset;offset<o+sPadding;++offset){dst[offset]=0}signature.copy(dst,offset,sOffset+Math.max(-sPadding,0),sOffset+sLength);dst=dst.toString("base64");dst=base64Url(dst);return dst}function countPadding(buf,start,stop){var padding=0;while(start+padding<stop&&buf[start+padding]===0){++padding}var needsSign=buf[start+padding]>=MAX_OCTET;if(needsSign){--padding}return padding}function joseToDer(signature,alg){signature=signatureAsBuffer(signature);var paramBytes=paramBytesForAlg_1(alg);var signatureBytes=signature.length;if(signatureBytes!==paramBytes*2){throw new TypeError('"'+alg+'" signatures must be "'+paramBytes*2+'" bytes, saw "'+signatureBytes+'"')}var rPadding=countPadding(signature,0,paramBytes);var sPadding=countPadding(signature,paramBytes,signature.length);var rLength=paramBytes-rPadding;var sLength=paramBytes-sPadding;var rsBytes=1+1+rLength+1+1+sLength;var shortLength=rsBytes<MAX_OCTET;var dst=Buffer$4.allocUnsafe((shortLength?2:3)+rsBytes);var offset=0;dst[offset++]=ENCODED_TAG_SEQ;if(shortLength){dst[offset++]=rsBytes}else{dst[offset++]=MAX_OCTET|1;dst[offset++]=rsBytes&255}dst[offset++]=ENCODED_TAG_INT;dst[offset++]=rLength;if(rPadding<0){dst[offset++]=0;offset+=signature.copy(dst,offset,0,paramBytes)}else{offset+=signature.copy(dst,offset,rPadding,paramBytes)}dst[offset++]=ENCODED_TAG_INT;dst[offset++]=sLength;if(sPadding<0){dst[offset++]=0;signature.copy(dst,offset,paramBytes)}else{signature.copy(dst,offset,paramBytes+sPadding)}return dst}var ecdsaSigFormatter={derToJose:derToJose,joseToDer:joseToDer};var Buffer$2=index$14.Buffer;var MSG_INVALID_ALGORITHM='"%s" is not a valid algorithm.\n  Supported algorithms are:\n  "HS256", "HS384", "HS512", "RS256", "RS384", "RS512" and "none".';var MSG_INVALID_SECRET="secret must be a string or buffer";var MSG_INVALID_VERIFIER_KEY="key must be a string or a buffer";var MSG_INVALID_SIGNER_KEY="key must be a string, a buffer or an object";function typeError(template){var args=[].slice.call(arguments,1);var errMsg=util$1.format.bind(util$1,template).apply(null,args);return new TypeError(errMsg)}function bufferOrString(obj){return Buffer$2.isBuffer(obj)||typeof obj==="string"}function normalizeInput(thing){if(!bufferOrString(thing))thing=JSON.stringify(thing);return thing}function createHmacSigner(bits){return function sign(thing,secret){if(!bufferOrString(secret))throw typeError(MSG_INVALID_SECRET);thing=normalizeInput(thing);var hmac=crypto$1.createHmac("sha"+bits,secret);var sig=(hmac.update(thing),hmac.digest("base64"));return index$12.fromBase64(sig)}}function createHmacVerifier(bits){return function verify(thing,signature,secret){var computedSig=createHmacSigner(bits)(thing,secret);return index$18(Buffer$2.from(signature),Buffer$2.from(computedSig))}}function createKeySigner(bits){return function sign(thing,privateKey){if(!bufferOrString(privateKey)&&!(typeof privateKey==="object"))throw typeError(MSG_INVALID_SIGNER_KEY);thing=normalizeInput(thing);var signer=crypto$1.createSign("RSA-SHA"+bits);var sig=(signer.update(thing),signer.sign(privateKey,"base64"));return index$12.fromBase64(sig)}}function createKeyVerifier(bits){return function verify(thing,signature,publicKey){if(!bufferOrString(publicKey))throw typeError(MSG_INVALID_VERIFIER_KEY);thing=normalizeInput(thing);signature=index$12.toBase64(signature);var verifier=crypto$1.createVerify("RSA-SHA"+bits);verifier.update(thing);return verifier.verify(publicKey,signature,"base64")}}function createECDSASigner(bits){var inner=createKeySigner(bits);return function sign(){var signature=inner.apply(null,arguments);signature=ecdsaSigFormatter.derToJose(signature,"ES"+bits);return signature}}function createECDSAVerifer(bits){var inner=createKeyVerifier(bits);return function verify(thing,signature,publicKey){signature=ecdsaSigFormatter.joseToDer(signature,"ES"+bits).toString("base64");var result=inner(thing,signature,publicKey);return result}}function createNoneSigner(){return function sign(){return""}}function createNoneVerifier(){return function verify(thing,signature){return signature===""}}var index$16=function jwa(algorithm){var signerFactories={hs:createHmacSigner,rs:createKeySigner,es:createECDSASigner,none:createNoneSigner};var verifierFactories={hs:createHmacVerifier,rs:createKeyVerifier,es:createECDSAVerifer,none:createNoneVerifier};var match=algorithm.match(/^(RS|ES|HS)(256|384|512)$|^(none)$/i);if(!match)throw typeError(MSG_INVALID_ALGORITHM,algorithm);var algo=(match[1]||match[3]).toLowerCase();var bits=match[2];return{sign:signerFactories[algo](bits),verify:verifierFactories[algo](bits)}};var Buffer$5=require$$0$2.Buffer;var tostring=function toString(obj){if(typeof obj==="string")return obj;if(typeof obj==="number"||Buffer$5.isBuffer(obj))return obj.toString();return JSON.stringify(obj)};function jwsSecuredInput(header,payload,encoding){encoding=encoding||"utf8";var encodedHeader=index$12(tostring(header),"binary");var encodedPayload=index$12(tostring(payload),encoding);return util$1.format("%s.%s",encodedHeader,encodedPayload)}function jwsSign(opts){var header=opts.header;var payload=opts.payload;var secretOrKey=opts.secret||opts.privateKey;var encoding=opts.encoding;var algo=index$16(header.alg);var securedInput=jwsSecuredInput(header,payload,encoding);var signature=algo.sign(securedInput,secretOrKey);return util$1.format("%s.%s",securedInput,signature)}function SignStream(opts){var secret=opts.secret||opts.privateKey||opts.key;var secretStream=new dataStream(secret);this.readable=true;this.header=opts.header;this.encoding=opts.encoding;this.secret=this.privateKey=this.key=secretStream;this.payload=new dataStream(opts.payload);this.secret.once("close",function(){if(!this.payload.writable&&this.readable)this.sign()}.bind(this));this.payload.once("close",function(){if(!this.secret.writable&&this.readable)this.sign()}.bind(this))}util$1.inherits(SignStream,Stream);SignStream.prototype.sign=function sign(){try{var signature=jwsSign({header:this.header,payload:this.payload.buffer,secret:this.secret.buffer,encoding:this.encoding});this.emit("done",signature);this.emit("data",signature);this.emit("end");this.readable=false;return signature}catch(e){this.readable=false;this.emit("error",e);this.emit("close")}};SignStream.sign=jwsSign;var signStream=SignStream;var JWS_REGEX=/^[a-zA-Z0-9\-_]+?\.[a-zA-Z0-9\-_]+?\.([a-zA-Z0-9\-_]+)?$/;function isObject(thing){return Object.prototype.toString.call(thing)==="[object Object]"}function safeJsonParse(thing){if(isObject(thing))return thing;try{return JSON.parse(thing)}catch(e){return undefined}}function headerFromJWS(jwsSig){var encodedHeader=jwsSig.split(".",1)[0];return safeJsonParse(index$12.decode(encodedHeader,"binary"))}function securedInputFromJWS(jwsSig){return jwsSig.split(".",2).join(".")}function signatureFromJWS(jwsSig){return jwsSig.split(".")[2]}function payloadFromJWS(jwsSig,encoding){encoding=encoding||"utf8";var payload=jwsSig.split(".")[1];return index$12.decode(payload,encoding)}function isValidJws(string){return JWS_REGEX.test(string)&&!!headerFromJWS(string)}function jwsVerify(jwsSig,algorithm,secretOrKey){if(!algorithm){var err=new Error("Missing algorithm parameter for jws.verify");err.code="MISSING_ALGORITHM";throw err}jwsSig=tostring(jwsSig);var signature=signatureFromJWS(jwsSig);var securedInput=securedInputFromJWS(jwsSig);var algo=index$16(algorithm);return algo.verify(securedInput,signature,secretOrKey)}function jwsDecode(jwsSig,opts){opts=opts||{};jwsSig=tostring(jwsSig);if(!isValidJws(jwsSig))return null;var header=headerFromJWS(jwsSig);if(!header)return null;var payload=payloadFromJWS(jwsSig);if(header.typ==="JWT"||opts.json)payload=JSON.parse(payload,opts.encoding);return{header:header,payload:payload,signature:signatureFromJWS(jwsSig)}}function VerifyStream(opts){opts=opts||{};var secretOrKey=opts.secret||opts.publicKey||opts.key;var secretStream=new dataStream(secretOrKey);this.readable=true;this.algorithm=opts.algorithm;this.encoding=opts.encoding;this.secret=this.publicKey=this.key=secretStream;this.signature=new dataStream(opts.signature);this.secret.once("close",function(){if(!this.signature.writable&&this.readable)this.verify()}.bind(this));this.signature.once("close",function(){if(!this.secret.writable&&this.readable)this.verify()}.bind(this))}util$1.inherits(VerifyStream,Stream);VerifyStream.prototype.verify=function verify(){try{var valid=jwsVerify(this.signature.buffer,this.algorithm,this.key.buffer);var obj=jwsDecode(this.signature.buffer,this.encoding);this.emit("done",valid,obj);this.emit("data",valid);this.emit("end");this.readable=false;return valid}catch(e){this.readable=false;this.emit("error",e);this.emit("close")}};VerifyStream.decode=jwsDecode;VerifyStream.isValid=isValidJws;VerifyStream.verify=jwsVerify;var verifyStream=VerifyStream;var ALGORITHMS=["HS256","HS384","HS512","RS256","RS384","RS512","ES256","ES384","ES512"];var ALGORITHMS_1=ALGORITHMS;var sign=signStream.sign;var verify=verifyStream.verify;var decode$2=verifyStream.decode;var isValid=verifyStream.isValid;var createSign=function createSign(opts){return new signStream(opts)};var createVerify=function createVerify(opts){return new verifyStream(opts)};var index$10={ALGORITHMS:ALGORITHMS_1,sign:sign,verify:verify,decode:decode$2,isValid:isValid,createSign:createSign,createVerify:createVerify};var decode=function(jwt,options){options=options||{};var decoded=index$10.decode(jwt,options);if(!decoded){return null}var payload=decoded.payload;if(typeof payload==="string"){try{var obj=JSON.parse(payload);if(typeof obj==="object"){payload=obj}}catch(e){}}if(options.complete===true){return{header:decoded.header,payload:payload,signature:decoded.signature}}return payload};var JsonWebTokenError=function(message,error){Error.call(this,message);Error.captureStackTrace(this,this.constructor);this.name="JsonWebTokenError";this.message=message;if(error)this.inner=error};JsonWebTokenError.prototype=Object.create(Error.prototype);JsonWebTokenError.prototype.constructor=JsonWebTokenError;var JsonWebTokenError_1=JsonWebTokenError;var NotBeforeError=function(message,date){JsonWebTokenError_1.call(this,message);this.name="NotBeforeError";this.date=date};NotBeforeError.prototype=Object.create(JsonWebTokenError_1.prototype);NotBeforeError.prototype.constructor=NotBeforeError;var NotBeforeError_1=NotBeforeError;var TokenExpiredError=function(message,expiredAt){JsonWebTokenError_1.call(this,message);this.name="TokenExpiredError";this.expiredAt=expiredAt};TokenExpiredError.prototype=Object.create(JsonWebTokenError_1.prototype);TokenExpiredError.prototype.constructor=TokenExpiredError;var TokenExpiredError_1=TokenExpiredError;var s$2=1e3;var m$2=s$2*60;var h$2=m$2*60;var d$2=h$2*24;var y$2=d$2*365.25;var index$20=function(val,options){options=options||{};var type=typeof val;if(type==="string"&&val.length>0){return parse$2(val)}else if(type==="number"&&isNaN(val)===false){return options.long?fmtLong$2(val):fmtShort$2(val)}throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(val))};function parse$2(str){str=String(str);if(str.length>1e4){return}var match=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(str);if(!match){return}var n=parseFloat(match[1]);var type=(match[2]||"ms").toLowerCase();switch(type){case"years":case"year":case"yrs":case"yr":case"y":return n*y$2;case"days":case"day":case"d":return n*d$2;case"hours":case"hour":case"hrs":case"hr":case"h":return n*h$2;case"minutes":case"minute":case"mins":case"min":case"m":return n*m$2;case"seconds":case"second":case"secs":case"sec":case"s":return n*s$2;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return undefined}}function fmtShort$2(ms){if(ms>=d$2){return Math.round(ms/d$2)+"d"}if(ms>=h$2){return Math.round(ms/h$2)+"h"}if(ms>=m$2){return Math.round(ms/m$2)+"m"}if(ms>=s$2){return Math.round(ms/s$2)+"s"}return ms+"ms"}function fmtLong$2(ms){return plural$2(ms,d$2,"day")||plural$2(ms,h$2,"hour")||plural$2(ms,m$2,"minute")||plural$2(ms,s$2,"second")||ms+" ms"}function plural$2(ms,n,name){if(ms<n){return}if(ms<n*1.5){return Math.floor(ms/n)+" "+name}return Math.ceil(ms/n)+" "+name+"s"}var immutable=extend;var hasOwnProperty$1=Object.prototype.hasOwnProperty;function extend(){var target={};for(var i=0;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(hasOwnProperty$1.call(source,key)){target[key]=source[key]}}}return target}var verify$1=function(jwtString,secretOrPublicKey,options,callback){if(typeof options==="function"&&!callback){callback=options;options={}}if(!options){options={}}options=immutable(options);var done;if(callback){done=function(){var args=Array.prototype.slice.call(arguments,0);return process.nextTick(function(){callback.apply(null,args)})}}else{done=function(err,data){if(err)throw err;return data}}if(options.clockTimestamp&&typeof options.clockTimestamp!=="number"){return done(new JsonWebTokenError_1("clockTimestamp must be a number"))}var clockTimestamp=options.clockTimestamp||Math.floor(Date.now()/1e3);if(!jwtString){return done(new JsonWebTokenError_1("jwt must be provided"))}if(typeof jwtString!=="string"){return done(new JsonWebTokenError_1("jwt must be a string"))}var parts=jwtString.split(".");if(parts.length!==3){return done(new JsonWebTokenError_1("jwt malformed"))}var hasSignature=parts[2].trim()!=="";if(!hasSignature&&secretOrPublicKey){return done(new JsonWebTokenError_1("jwt signature is required"))}if(hasSignature&&!secretOrPublicKey){return done(new JsonWebTokenError_1("secret or public key must be provided"))}if(!hasSignature&&!options.algorithms){options.algorithms=["none"]}if(!options.algorithms){options.algorithms=~secretOrPublicKey.toString().indexOf("BEGIN CERTIFICATE")||~secretOrPublicKey.toString().indexOf("BEGIN PUBLIC KEY")?["RS256","RS384","RS512","ES256","ES384","ES512"]:~secretOrPublicKey.toString().indexOf("BEGIN RSA PUBLIC KEY")?["RS256","RS384","RS512"]:["HS256","HS384","HS512"]}var decodedToken;try{decodedToken=index$10.decode(jwtString)}catch(err){return done(err)}if(!decodedToken){return done(new JsonWebTokenError_1("invalid token"))}var header=decodedToken.header;if(!~options.algorithms.indexOf(header.alg)){return done(new JsonWebTokenError_1("invalid algorithm"))}var valid;try{valid=index$10.verify(jwtString,header.alg,secretOrPublicKey)}catch(e){return done(e)}if(!valid)return done(new JsonWebTokenError_1("invalid signature"));var payload;try{payload=decode(jwtString)}catch(err){return done(err)}if(typeof payload.nbf!=="undefined"&&!options.ignoreNotBefore){if(typeof payload.nbf!=="number"){return done(new JsonWebTokenError_1("invalid nbf value"))}if(payload.nbf>clockTimestamp+(options.clockTolerance||0)){return done(new NotBeforeError_1("jwt not active",new Date(payload.nbf*1e3)))}}if(typeof payload.exp!=="undefined"&&!options.ignoreExpiration){if(typeof payload.exp!=="number"){return done(new JsonWebTokenError_1("invalid exp value"))}if(clockTimestamp>=payload.exp+(options.clockTolerance||0)){return done(new TokenExpiredError_1("jwt expired",new Date(payload.exp*1e3)))}}if(options.audience){var audiences=Array.isArray(options.audience)?options.audience:[options.audience];var target=Array.isArray(payload.aud)?payload.aud:[payload.aud];var match=target.some(function(aud){return audiences.indexOf(aud)!=-1});if(!match)return done(new JsonWebTokenError_1("jwt audience invalid. expected: "+audiences.join(" or ")))}if(options.issuer){var invalid_issuer=typeof options.issuer==="string"&&payload.iss!==options.issuer||Array.isArray(options.issuer)&&options.issuer.indexOf(payload.iss)===-1;if(invalid_issuer){return done(new JsonWebTokenError_1("jwt issuer invalid. expected: "+options.issuer))}}if(options.subject){if(payload.sub!==options.subject){return done(new JsonWebTokenError_1("jwt subject invalid. expected: "+options.subject))}}if(options.jwtid){if(payload.jti!==options.jwtid){return done(new JsonWebTokenError_1("jwt jwtid invalid. expected: "+options.jwtid))}}if(options.maxAge){var maxAge=index$20(options.maxAge);if(typeof payload.iat!=="number"){return done(new JsonWebTokenError_1("iat required when maxAge is specified"))}var nowOrClockTimestamp=(options.clockTimestamp||0)*1e3||Date.now();if(nowOrClockTimestamp-payload.iat*1e3>maxAge+(options.clockTolerance||0)*1e3){return done(new TokenExpiredError_1("maxAge exceeded",new Date(payload.iat*1e3+maxAge)))}}return done(null,payload)};var timespan=function(time,iat){var timestamp=iat||Math.floor(Date.now()/1e3);if(typeof time==="string"){var milliseconds=index$20(time);if(typeof milliseconds==="undefined"){return}return Math.floor(timestamp+milliseconds/1e3)}else if(typeof time==="number"){return timestamp+time}else{return}};var INFINITY=1/0;var MAX_SAFE_INTEGER=9007199254740991;var MAX_INTEGER=1.7976931348623157e308;var NAN=0/0;var argsTag="[object Arguments]";var funcTag="[object Function]";var genTag="[object GeneratorFunction]";var stringTag="[object String]";var symbolTag="[object Symbol]";var reTrim=/^\s+|\s+$/g;var reIsBadHex=/^[-+]0x[0-9a-f]+$/i;var reIsBinary=/^0b[01]+$/i;var reIsOctal=/^0o[0-7]+$/i;var reIsUint=/^(?:0|[1-9]\d*)$/;var freeParseInt=parseInt;function arrayMap(array,iteratee){var index=-1,length=array?array.length:0,result=Array(length);while(++index<length){result[index]=iteratee(array[index],index,array)}return result}function baseFindIndex(array,predicate,fromIndex,fromRight){var length=array.length,index=fromIndex+(fromRight?1:-1);while(fromRight?index--:++index<length){if(predicate(array[index],index,array)){return index}}return-1}function baseIndexOf(array,value,fromIndex){if(value!==value){return baseFindIndex(array,baseIsNaN,fromIndex)}var index=fromIndex-1,length=array.length;while(++index<length){if(array[index]===value){return index}}return-1}function baseIsNaN(value){return value!==value}function baseTimes(n,iteratee){var index=-1,result=Array(n);while(++index<n){result[index]=iteratee(index)}return result}function baseValues(object,props){return arrayMap(props,function(key){return object[key]})}function overArg(func,transform){return function(arg){return func(transform(arg))}}var objectProto=Object.prototype;var hasOwnProperty$2=objectProto.hasOwnProperty;var objectToString=objectProto.toString;var propertyIsEnumerable=objectProto.propertyIsEnumerable;var nativeKeys=overArg(Object.keys,Object);var nativeMax=Math.max;function arrayLikeKeys(value,inherited){var result=isArray(value)||isArguments(value)?baseTimes(value.length,String):[];var length=result.length,skipIndexes=!!length;for(var key in value){if((inherited||hasOwnProperty$2.call(value,key))&&!(skipIndexes&&(key=="length"||isIndex(key,length)))){result.push(key)}}return result}function baseKeys(object){if(!isPrototype(object)){return nativeKeys(object)}var result=[];for(var key in Object(object)){if(hasOwnProperty$2.call(object,key)&&key!="constructor"){result.push(key)}}return result}function isIndex(value,length){length=length==null?MAX_SAFE_INTEGER:length;return!!length&&(typeof value=="number"||reIsUint.test(value))&&(value>-1&&value%1==0&&value<length)}function isPrototype(value){var Ctor=value&&value.constructor,proto=typeof Ctor=="function"&&Ctor.prototype||objectProto;return value===proto}function includes(collection,value,fromIndex,guard){collection=isArrayLike(collection)?collection:values(collection);fromIndex=fromIndex&&!guard?toInteger(fromIndex):0;var length=collection.length;if(fromIndex<0){fromIndex=nativeMax(length+fromIndex,0)}return isString(collection)?fromIndex<=length&&collection.indexOf(value,fromIndex)>-1:!!length&&baseIndexOf(collection,value,fromIndex)>-1}function isArguments(value){return isArrayLikeObject(value)&&hasOwnProperty$2.call(value,"callee")&&(!propertyIsEnumerable.call(value,"callee")||objectToString.call(value)==argsTag)}var isArray=Array.isArray;function isArrayLike(value){return value!=null&&isLength(value.length)&&!isFunction(value)}function isArrayLikeObject(value){return isObjectLike(value)&&isArrayLike(value)}function isFunction(value){var tag=isObject$1(value)?objectToString.call(value):"";return tag==funcTag||tag==genTag}function isLength(value){return typeof value=="number"&&value>-1&&value%1==0&&value<=MAX_SAFE_INTEGER}function isObject$1(value){var type=typeof value;return!!value&&(type=="object"||type=="function")}function isObjectLike(value){return!!value&&typeof value=="object"}function isString(value){return typeof value=="string"||!isArray(value)&&isObjectLike(value)&&objectToString.call(value)==stringTag}function isSymbol(value){return typeof value=="symbol"||isObjectLike(value)&&objectToString.call(value)==symbolTag}function toFinite(value){if(!value){return value===0?value:0}value=toNumber(value);if(value===INFINITY||value===-INFINITY){var sign=value<0?-1:1;return sign*MAX_INTEGER}return value===value?value:0}function toInteger(value){var result=toFinite(value),remainder=result%1;return result===result?remainder?result-remainder:result:0}function toNumber(value){if(typeof value=="number"){return value}if(isSymbol(value)){return NAN}if(isObject$1(value)){var other=typeof value.valueOf=="function"?value.valueOf():value;value=isObject$1(other)?other+"":other}if(typeof value!="string"){return value===0?value:+value}value=value.replace(reTrim,"");var isBinary=reIsBinary.test(value);return isBinary||reIsOctal.test(value)?freeParseInt(value.slice(2),isBinary?2:8):reIsBadHex.test(value)?NAN:+value}function keys(object){return isArrayLike(object)?arrayLikeKeys(object):baseKeys(object)}function values(object){return object?baseValues(object,keys(object)):[]}var index$22=includes;var isArray$1=Array.isArray;var index$24=isArray$1;var boolTag="[object Boolean]";var objectProto$1=Object.prototype;var objectToString$1=objectProto$1.toString;function isBoolean(value){return value===true||value===false||isObjectLike$1(value)&&objectToString$1.call(value)==boolTag}function isObjectLike$1(value){return!!value&&typeof value=="object"}var index$26=isBoolean;var INFINITY$1=1/0;var MAX_INTEGER$1=1.7976931348623157e308;var NAN$1=0/0;var symbolTag$1="[object Symbol]";var reTrim$1=/^\s+|\s+$/g;var reIsBadHex$1=/^[-+]0x[0-9a-f]+$/i;var reIsBinary$1=/^0b[01]+$/i;var reIsOctal$1=/^0o[0-7]+$/i;var freeParseInt$1=parseInt;var objectProto$2=Object.prototype;var objectToString$2=objectProto$2.toString;function isInteger(value){return typeof value=="number"&&value==toInteger$1(value)}function isObject$2(value){var type=typeof value;return!!value&&(type=="object"||type=="function")}function isObjectLike$2(value){return!!value&&typeof value=="object"}function isSymbol$1(value){return typeof value=="symbol"||isObjectLike$2(value)&&objectToString$2.call(value)==symbolTag$1}function toFinite$1(value){if(!value){return value===0?value:0}value=toNumber$1(value);if(value===INFINITY$1||value===-INFINITY$1){var sign=value<0?-1:1;return sign*MAX_INTEGER$1}return value===value?value:0}function toInteger$1(value){var result=toFinite$1(value),remainder=result%1;return result===result?remainder?result-remainder:result:0}function toNumber$1(value){if(typeof value=="number"){return value}if(isSymbol$1(value)){return NAN$1}if(isObject$2(value)){var other=typeof value.valueOf=="function"?value.valueOf():value;value=isObject$2(other)?other+"":other}if(typeof value!="string"){return value===0?value:+value}value=value.replace(reTrim$1,"");var isBinary=reIsBinary$1.test(value);return isBinary||reIsOctal$1.test(value)?freeParseInt$1(value.slice(2),isBinary?2:8):reIsBadHex$1.test(value)?NAN$1:+value}var index$28=isInteger;var numberTag="[object Number]";var objectProto$3=Object.prototype;var objectToString$3=objectProto$3.toString;function isObjectLike$3(value){return!!value&&typeof value=="object"}function isNumber(value){return typeof value=="number"||isObjectLike$3(value)&&objectToString$3.call(value)==numberTag}var index$30=isNumber;var objectTag="[object Object]";function isHostObject(value){var result=false;if(value!=null&&typeof value.toString!="function"){try{result=!!(value+"")}catch(e){}}return result}function overArg$1(func,transform){return function(arg){return func(transform(arg))}}var funcProto=Function.prototype;var objectProto$4=Object.prototype;var funcToString=funcProto.toString;var hasOwnProperty$3=objectProto$4.hasOwnProperty;var objectCtorString=funcToString.call(Object);var objectToString$4=objectProto$4.toString;var getPrototype=overArg$1(Object.getPrototypeOf,Object);function isObjectLike$4(value){return!!value&&typeof value=="object"}function isPlainObject(value){if(!isObjectLike$4(value)||objectToString$4.call(value)!=objectTag||isHostObject(value)){return false}var proto=getPrototype(value);if(proto===null){return true}var Ctor=hasOwnProperty$3.call(proto,"constructor")&&proto.constructor;return typeof Ctor=="function"&&Ctor instanceof Ctor&&funcToString.call(Ctor)==objectCtorString}var index$32=isPlainObject;var stringTag$1="[object String]";var objectProto$5=Object.prototype;var objectToString$5=objectProto$5.toString;var isArray$2=Array.isArray;function isObjectLike$5(value){return!!value&&typeof value=="object"}function isString$1(value){return typeof value=="string"||!isArray$2(value)&&isObjectLike$5(value)&&objectToString$5.call(value)==stringTag$1}var index$34=isString$1;var FUNC_ERROR_TEXT="Expected a function";var INFINITY$2=1/0;var MAX_INTEGER$2=1.7976931348623157e308;var NAN$2=0/0;var symbolTag$2="[object Symbol]";var reTrim$2=/^\s+|\s+$/g;var reIsBadHex$2=/^[-+]0x[0-9a-f]+$/i;var reIsBinary$2=/^0b[01]+$/i;var reIsOctal$2=/^0o[0-7]+$/i;var freeParseInt$2=parseInt;var objectProto$6=Object.prototype;var objectToString$6=objectProto$6.toString;function before(n,func){var result;if(typeof func!="function"){throw new TypeError(FUNC_ERROR_TEXT)}n=toInteger$2(n);return function(){if(--n>0){result=func.apply(this,arguments)}if(n<=1){func=undefined}return result}}function once(func){return before(2,func)}function isObject$3(value){var type=typeof value;return!!value&&(type=="object"||type=="function")}function isObjectLike$6(value){return!!value&&typeof value=="object"}function isSymbol$2(value){return typeof value=="symbol"||isObjectLike$6(value)&&objectToString$6.call(value)==symbolTag$2}function toFinite$2(value){if(!value){return value===0?value:0}value=toNumber$2(value);if(value===INFINITY$2||value===-INFINITY$2){var sign=value<0?-1:1;return sign*MAX_INTEGER$2}return value===value?value:0}function toInteger$2(value){var result=toFinite$2(value),remainder=result%1;return result===result?remainder?result-remainder:result:0}function toNumber$2(value){if(typeof value=="number"){return value}if(isSymbol$2(value)){return NAN$2}if(isObject$3(value)){var other=typeof value.valueOf=="function"?value.valueOf():value;value=isObject$3(other)?other+"":other}if(typeof value!="string"){return value===0?value:+value}value=value.replace(reTrim$2,"");var isBinary=reIsBinary$2.test(value);return isBinary||reIsOctal$2.test(value)?freeParseInt$2(value.slice(2),isBinary?2:8):reIsBadHex$2.test(value)?NAN$2:+value}var index$36=once;var sign_options_schema={expiresIn:function(value){return index$28(value)||index$34(value)},notBefore:function(value){return index$28(value)||index$34(value)},audience:function(value){return index$34(value)||index$24(value)},algorithm:index$22.bind(null,["RS256","RS384","RS512","ES256","ES384","ES512","HS256","HS384","HS512","none"]),header:index$32,encoding:index$34,issuer:index$34,subject:index$34,jwtid:index$34,noTimestamp:index$26,keyid:index$34};var registered_claims_schema={iat:index$30,exp:index$30,nbf:index$30};function validate(schema,unknown,object){if(!index$32(object)){throw new Error("Expected object")}Object.keys(object).forEach(function(key){if(schema[key]==null){if(!unknown){throw new Error('"'+key+'" is not allowed')}return}if(!schema[key](object[key])){throw new Error('"'+key+'" is not the correct type')}})}var options_to_payload={audience:"aud",issuer:"iss",subject:"sub",jwtid:"jti"};var options_for_objects=["expiresIn","notBefore","noTimestamp","audience","issuer","subject","jwtid"];var sign$1=function(payload,secretOrPrivateKey,options,callback){if(typeof options==="function"){callback=options;options={}}else{options=options||{}}var isObjectPayload=typeof payload==="object"&&!Buffer.isBuffer(payload);var header=immutable({alg:options.algorithm||"HS256",typ:isObjectPayload?"JWT":undefined,kid:options.keyid},options.header);function failure(err){if(callback){return callback(err)}throw err}if(typeof payload==="undefined"){return failure(new Error("payload is required"))}else if(isObjectPayload){try{validate(registered_claims_schema,true,payload)}catch(error){return failure(error)}payload=immutable(payload)}else{var invalid_options=options_for_objects.filter(function(opt){return typeof options[opt]!=="undefined"});if(invalid_options.length>0){return failure(new Error("invalid "+invalid_options.join(",")+" option for "+typeof payload+" payload"))}}if(typeof payload.exp!=="undefined"&&typeof options.expiresIn!=="undefined"){return failure(new Error('Bad "options.expiresIn" option the payload already has an "exp" property.'))}if(typeof payload.nbf!=="undefined"&&typeof options.notBefore!=="undefined"){return failure(new Error('Bad "options.notBefore" option the payload already has an "nbf" property.'))}try{validate(sign_options_schema,false,options)}catch(error){return failure(error)}var timestamp=payload.iat||Math.floor(Date.now()/1e3);if(!options.noTimestamp){payload.iat=timestamp}else{delete payload.iat}if(typeof options.notBefore!=="undefined"){payload.nbf=timespan(options.notBefore);if(typeof payload.nbf==="undefined"){return failure(new Error('"notBefore" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}}if(typeof options.expiresIn!=="undefined"&&typeof payload==="object"){payload.exp=timespan(options.expiresIn,timestamp);if(typeof payload.exp==="undefined"){return failure(new Error('"expiresIn" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}}Object.keys(options_to_payload).forEach(function(key){var claim=options_to_payload[key];if(typeof options[key]!=="undefined"){if(typeof payload[claim]!=="undefined"){return failure(new Error('Bad "options.'+key+'" option. The payload already has an "'+claim+'" property.'))}payload[claim]=options[key]}});var encoding=options.encoding||"utf8";if(typeof callback==="function"){callback=callback&&index$36(callback);index$10.createSign({header:header,privateKey:secretOrPrivateKey,payload:payload,encoding:encoding}).once("error",callback).once("done",function(signature){callback(null,signature)})}else{return index$10.sign({header:header,payload:payload,secret:secretOrPrivateKey,encoding:encoding})}};var index$8={decode:decode,verify:verify$1,sign:sign$1,JsonWebTokenError:JsonWebTokenError_1,NotBeforeError:NotBeforeError_1,TokenExpiredError:TokenExpiredError_1};var serviceSecret=createCommonjsModule(function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const secret=process.env.SERVICE_TOKEN_SECRET;if(!secret){throw new Error("no $SERVICE_TOKEN_SECRET provided")}exports.signServiceSecret=(()=>index$8.sign({baseUrl:baseUrl.baseUrl},secret,{algorithm:"HS256",expiresIn:30}));exports.verifyServiceSecret=(opaqueObject=>{const{baseUrl:foundBaseUrl}=index$8.verify(opaqueObject,secret,{algorithms:["HS256"],clockTolerance:30});if(foundBaseUrl!==baseUrl.baseUrl){const e=new Error("Incorrect service secret");e.invalidServiceSecret=foundBaseUrl;throw e}})});var url_1=url&&url__default||url;var fetch=createCommonjsModule(function(module,exports){"use strict";var __awaiter=commonjsGlobal&&commonjsGlobal.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:true});const isApiResponseError=response=>"error"in response;const getFunctionPrefix=baseUrl$$1=>{const{hostname:hostname}=url_1.parse(baseUrl$$1);if(hostname==null){throw new Error(`Failed to parse ${baseUrl$$1}`)}const branch=hostname.split(".")[0];return branch==="live"?"honesty-store-":`hs-${branch}-`};exports.default=((service,baseUrl$$1=baseUrl.baseUrl)=>{const getUrl=(version,path)=>`/${service}/v${version}${path}`;const fetchAndParse=({method:method,url:url$$1,key:key$$1,body:body=undefined})=>__awaiter(commonjsGlobal,void 0,void 0,function*(){log_1.info(key$$1,`send ${method} ${url$$1}`);const request={serviceSecret:serviceSecret.signServiceSecret(),key:key$$1,method:method,path:url$$1,body:body};const response=yield new aws_sdk_1.Lambda({apiVersion:"2015-03-31"}).invoke({InvocationType:"RequestResponse",FunctionName:getFunctionPrefix(baseUrl$$1)+service,Payload:JSON.stringify(request)}).promise();let json;try{json=JSON.parse(response.Payload)}catch(e){log_1.error(key$$1,`failed ${method} ${url$$1}, couldn't parse json`,{httpStatus:response.StatusCode,responseText:response.Payload});throw new Error(`${method} ${url$$1} failed (couldn't parse json), HTTP ${response.StatusCode}`)}if(response.StatusCode==null||response.StatusCode<200||response.StatusCode>=300){log_1.error(key$$1,`failed non-2xx ${method} ${url$$1} ${response.StatusCode}`);throw new Error(`${method} ${url$$1} failed (non-2xx response), HTTP ${response.StatusCode}`)}if(isApiResponseError(json)){log_1.error(key$$1,`error ${method} ${url$$1} ${json.error.message}`);if(json.error.code){throw new error$1.CodedError(json.error.code,json.error.message)}throw new Error(json.error.message)}log_1.info(key$$1,`success ${method} ${url$$1}`,{status:response.StatusCode,response:json});return json.response});const cache=asyncCache.default({max:1e3,maxAge:index$6("5s"),load:url$$1=>fetchAndParse({method:"GET",url:url$$1,key:key.createServiceKey({service:service})})});const get=(version,key$$1,path,cacheBypass=false)=>__awaiter(commonjsGlobal,void 0,void 0,function*(){const url$$1=getUrl(version,path);if(cacheBypass){return yield fetchAndParse({method:"GET",url:url$$1,key:key.createServiceKey({service:service})})}log_1.info(key$$1,`cache check for GET ${url$$1}`);return yield cache.get(url$$1)});const post=(version,key$$1,path,body)=>__awaiter(commonjsGlobal,void 0,void 0,function*(){return yield fetchAndParse({method:"POST",url:getUrl(version,path),key:key$$1,body:body})});const put=(version,key$$1,path,body)=>__awaiter(commonjsGlobal,void 0,void 0,function*(){return yield fetchAndParse({method:"PUT",url:getUrl(version,path),key:key$$1,body:body})});return{get:get,post:post,put:put}})});var index$2=createCommonjsModule(function(module,exports){"use strict";var __awaiter=commonjsGlobal&&commonjsGlobal.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};var __rest=commonjsGlobal&&commonjsGlobal.__rest||function(s,e){var t={};for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0)t[p]=s[p];if(s!=null&&typeof Object.getOwnPropertySymbols==="function")for(var i=0,p=Object.getOwnPropertySymbols(s);i<p.length;i++)if(e.indexOf(p[i])<0)t[p[i]]=s[p[i]];return t};Object.defineProperty(exports,"__esModule",{value:true});exports.balanceLimit=1e3;exports.AUTO_REFUND_PERIOD=index$4("24h");exports.transactionTypes=["topup","purchase","refund","debit","credit"];const isSHA256=hash=>/^[a-f0-9]{64}$/.test(hash);exports.extractFieldsFromTransactionId=(id=>{const[,accountId,transactionId,...rest]=/(.*):(.*)/.exec(id)||[];return{accountId:accountId,transactionId:transactionId,rest:rest}});exports.assertValidTransactionId=(id=>{const{accountId:accountId,transactionId:transactionId,rest:rest}=exports.extractFieldsFromTransactionId(id);if(rest.length){throw new Error(`Transaction id isn't <accountId>:<transactionHash> (${id})`)}if(!isUUID_1$1(accountId)){throw new Error(`Transaction id's accountId isn't a uuid (${accountId})`)}if(!isSHA256(transactionId)){throw new Error(`Transaction hash isn't a SHA256 hash (${transactionId})`)}});const assertValidLegacyId=assert.createAssertValidUuid("legacyId");const isValidTransactionType=type=>exports.transactionTypes.some(x=>x===type);exports.assertValidTransaction=(_a=>{var{type:type,amount:amount,data:data,id:id,other:other,next:next,legacyId:legacyId,timestamp:timestamp}=_a,rest=__rest(_a,["type","amount","data","id","other","next","legacyId","timestamp"]);exports.assertValidTransactionId(id);if(!isValidTransactionType(type)){throw new Error(`Invalid transaction type ${type}`)}if(!Number.isInteger(amount)){throw new Error(`Non-integral transaction amount ${amount}`)}switch(type){case"topup":case"refund":case"credit":if(amount<0){throw new Error(`Invalid transaction amount for type '${type}': ${amount}`)}break;case"debit":case"purchase":if(amount>0){throw new Error(`Invalid transaction amount for type '${type}': ${amount}`)}break;default:assert.assertNever(type)}if(data==null||typeof data!=="object"){throw new Error(`Invalid transaction data ${JSON.stringify(data)}`)}for(const key of Object.keys(data)){if(typeof data[key]!=="string"){throw new Error(`Invalid transaction data ${JSON.stringify(data)}`)}}if(other!=null){exports.assertValidTransactionId(other)}if(next!=null){exports.assertValidTransactionId(next)}if(legacyId!=null){assertValidLegacyId(legacyId)}if(!Number.isInteger(timestamp)){throw new Error(`Non-integral timestamp ${timestamp}`)}if(Object.keys(rest).length!==0){throw new Error("Invalid transaction properties supplied")}});const{get:get,post:post}=fetch.default("transaction");exports.createAccount=((key,accountId)=>post(1,key,"/account",{accountId:accountId}));exports.getAccount=((key,accountId)=>get(1,key,`/account/${accountId}`));exports.createTransaction=((key,accountId,transaction)=>post(1,key,`/account/${accountId}`,transaction));exports.getTransaction=((key,transactionId)=>get(1,key,`/tx/${transactionId}`));exports.issueUserRequestedRefund=((key,transactionId,userId,reason)=>post(1,key,`/tx/${transactionId}/refund/user`,{userId:userId,reason:reason}));exports.issueSupportRequestedRefund=((key,transactionId,reason,dateLimit)=>post(1,key,`/tx/${transactionId}/refund/support`,{dateLimit:dateLimit,reason:reason}));exports.recordTopup=((key,accountId,id,transaction)=>post(1,key,`/account/${accountId}/topup/${id}`,transaction));exports.assertBalanceWithinLimit=(({key:key,accountId:accountId,amount:amount})=>__awaiter(commonjsGlobal,void 0,void 0,function*(){const currentBalance=(yield exports.getAccount(key,accountId)).balance;if(!Number.isFinite(amount)||typeof amount!=="number"){throw new Error("amount is not a number")}if(currentBalance+amount>exports.balanceLimit){throw new error$1.CodedError("MaxBalanceExceeded",`topping up would increase balance over the limit of £${exports.balanceLimit/100}`)}}));exports.TEST_DATA_EMPTY_ACCOUNT_ID="b423607f-64de-441f-ac39-12d50aaedbe9"});var lambda=createCommonjsModule(function(module,exports){"use strict";var __awaiter=commonjsGlobal&&commonjsGlobal.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:true});const asyncHandler=event=>__awaiter(commonjsGlobal,void 0,void 0,function*(){const key$$1=key.createServiceKey({service:"transaction-store"});for(const topupAccount of stream$1.subscribeTopups(event)){if(topupAccount.status==null||topupAccount.status.status!=="in-progress"){return}yield index$2.recordTopup(key$$1,topupAccount.id,topupAccount.status.chargeId,{type:"topup",amount:topupAccount.status.amount,data:{stripeFee:String(topupAccount.status.stripeFee),chargeId:topupAccount.status.chargeId}})}return`Successfully processed ${event.Records.length} records`});exports.handler=((event,context)=>asyncHandler(event).then(info=>context.succeed(info)).catch(e=>context.fail(e)))});var lambda$1=unwrapExports(lambda);var lambda_1=lambda.handler;exports["default"]=lambda$1;exports.handler=lambda_1;
